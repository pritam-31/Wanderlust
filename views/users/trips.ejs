<% layout("/layouts/boilerplate") %>

<style>
    .trips-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 2rem 1rem;
    }
    
    .trips-header {
        background: linear-gradient(135deg, #2d3436 0%, #0984e3 100%);
        border-radius: 20px;
        padding: 2rem;
        color: white;
        margin-bottom: 2rem;
        box-shadow: 0 10px 30px rgba(13, 110, 253, 0.2);
    }
    
    .trips-tabs {
        display: flex;
        gap: 1rem;
        margin-bottom: 2rem;
        flex-wrap: wrap;
    }
    
    .trip-tab {
        padding: 0.75rem 1.5rem;
        background: #f8f9fa;
        border-radius: 10px;
        border: none;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .trip-tab.active {
        background: #0984e3;
        color: white;
    }
    
    .trip-card {
        border-radius: 15px;
        overflow: hidden;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        margin-bottom: 2rem;
        background: white;
        transition: transform 0.3s ease;
    }
    
    .trip-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 30px rgba(0, 0, 0, 0.15);
    }
    
    .trip-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1.5rem;
        background: #f8f9fa;
        border-bottom: 1px solid #eee;
    }
    
    .trip-status {
        padding: 0.25rem 1rem;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 600;
    }
    
    .status-upcoming {
        background: #d4edda;
        color: #155724;
    }
    
    .status-completed {
        background: #d1ecf1;
        color: #0c5460;
    }
    
    .status-cancelled {
        background: #f8d7da;
        color: #721c24;
    }
    
    .trip-content {
        padding: 1.5rem;
        display: grid;
        grid-template-columns: 300px 1fr;
        gap: 2rem;
    }
    
    .trip-image {
        width: 100%;
        height: 200px;
        object-fit: cover;
        border-radius: 10px;
    }
    
    .trip-details h4 {
        color: #333;
        margin-bottom: 1rem;
    }
    
    .trip-meta {
        display: flex;
        gap: 2rem;
        margin-bottom: 1.5rem;
        flex-wrap: wrap;
    }
    
    .meta-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        color: #666;
    }
    
    .meta-item i {
        color: #0984e3;
    }
    
    .trip-price {
        font-size: 1.5rem;
        font-weight: 700;
        color: #0984e3;
        margin: 1rem 0;
    }
    
    .trip-actions {
        display: flex;
        gap: 1rem;
        margin-top: 1.5rem;
    }
    
    .empty-trips {
        text-align: center;
        padding: 4rem 2rem;
        background: #f8f9fa;
        border-radius: 15px;
        margin: 2rem 0;
    }
    
    .empty-trips i {
        font-size: 5rem;
        color: #ddd;
        margin-bottom: 1.5rem;
    }
    
    .calendar-view {
        background: white;
        border-radius: 15px;
        padding: 1.5rem;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        margin-bottom: 2rem;
    }
    
    .month-navigation {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
    }
    
    .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 5px;
        text-align: center;
    }
    
    .calendar-day {
        padding: 10px;
        border-radius: 5px;
        background: #f8f9fa;
    }
    
    .calendar-day.trip-day {
        background: #0984e3;
        color: white;
        font-weight: bold;
    }
    
    .calendar-day-header {
        font-weight: 600;
        color: #666;
        padding: 10px;
    }
    
    @media (max-width: 768px) {
        .trip-content {
            grid-template-columns: 1fr;
        }
        
        .trip-meta {
            flex-direction: column;
            gap: 1rem;
        }
    }

    .trips-container { 
        max-width: 1200px; 
        margin: 0 auto; 
        padding: 2rem 1rem; 
    }
/* (CSS unchanged – tumhara pura CSS safe hai) */
</style>

<% layout("/layouts/boilerplate") %>

<style>
/* ================= STYLES SAME AS BEFORE ================= */
.trips-container { max-width: 1200px; margin: 0 auto; padding: 2rem 1rem; }
/* (CSS unchanged – tumhara pura CSS safe hai) */
</style>

<div class="trips-container">
<!-- ================= HEADER ================= -->
    <div class="trips-header">
        <h1 class="display-5 fw-bold mb-3">
            <i class="fas fa-suitcase-rolling me-3"></i>My Trips
        </h1>
        <p class="lead mb-0">
            Manage your upcoming trips, view past bookings, and plan your next adventure
        </p>
    </div>

    <!-- ================= TABS ================= -->
    <div class="trips-tabs">
        <button class="trip-tab active" data-tab="upcoming">
            Upcoming (<%= trips?.upcoming?.length || 0 %>)
        </button>
        <button class="trip-tab" data-tab="completed">
            Completed (<%= trips?.completed?.length || 0 %>)
        </button>
        <button class="trip-tab" data-tab="wishlist">
            Wishlist (<%= wishlist?.length || 0 %>)
        </button>
    </div>

    <!-- ================= UPCOMING TRIPS ================= -->
    <div class="trip-section" id="upcoming-trips">
    <% if (trips?.upcoming?.length) { %>
    <% trips.upcoming.forEach(trip => { %>
        <div class="trip-card">
            <div class="trip-header">
                <div>
                    <h4>Booking #<%= trip.bookingId || "N/A" %></h4>
                    <p class="text-muted">
                        Booked on <%= trip.bookedDate ? new Date(trip.bookedDate).toLocaleDateString("en-IN") : "N/A" %>
                    </p>
                </div>
                <span class="trip-status status-upcoming">Upcoming</span>
            </div>
            <div class="trip-content">
            <!-- IMAGE SAFE -->
            <div>
                <% if (trip?.listing?.image?.url) { %>
                    <img src="<%= trip.listing.image.url %>" class="trip-image">
                <% } else { %>
                    <img src="/images/no-image.jpg" class="trip-image">
                <% } %>
            </div>
            <div class="trip-details">
                <h4><%= trip?.listing?.title || "Listing Removed" %></h4>
                <p class="trip-price">
                    ₹<%= trip.totalPrice?.toLocaleString("en-IN") || 0 %>
                </p>
                <div class="trip-actions">
                <!-- ===== VIEW DETAILS SAFE ===== -->
                    <% if (trip?.listing?._id) { %>
                        <a href="/listings/<%= trip.listing._id %>" class="btn btn-primary">
                        View Details
                        </a>
                    <% } else { %>
                        <a href="#" class="btn btn-primary disabled">View Details</a>
                    <% } %>

                    <button class="btn btn-outline-danger cancel-trip-btn" data-id="<%= trip._id || '' %>">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
    <% }) %>
    <% } else { %>
    <div class="empty-trips">
        <h3>No Upcoming Trips</h3>
        <a href="/listings" class="btn btn-primary">Explore</a>
    </div>
    <% } %>
    </div>

    <!-- ================= COMPLETED TRIPS ================= -->
    <div class="trip-section d-none" id="completed-trips">
        <% if (trips?.completed?.length) { %>
        <% trips.completed.forEach(trip => { %>

        <div class="trip-card">
            <div class="trip-header">
                <h4><%= trip?.listing?.title || "Listing Removed" %></h4>
                <span class="trip-status status-completed">Completed</span>
            </div>
            <div class="trip-content">
                <div>
                    <% if (trip?.listing?.image?.url) { %>
                        <img src="<%= trip.listing.image.url %>" class="trip-image">
                    <% } else { %>
                        <img src="/images/no-image.jpg" class="trip-image">
                    <% } %>
                </div>
                <div class="trip-details">  
                    <div class="trip-actions">
                    <!-- ===== BOOK AGAIN SAFE ===== -->
                    <% if (trip?.listing?._id) { %>
                        <button class="btn btn-outline-primary rebook-btn" data-listing="<%= trip.listing._id %>">
                        Book Again
                        </button>
                    <% } else { %>
                        <button class="btn btn-outline-primary disabled">
                        Book Again
                        </button>
                    <% } %>
                </div>
            </div>
        </div>
    </div>
    <% }) %>
    <% } else { %>
    <div class="empty-trips">
        <h3>No Completed Trips</h3>
    </div>
    <% } %>
</div>

<!-- ================= WISHLIST ================= -->
<div class="trip-section d-none" id="wishlist-section">
    <% if (wishlist?.length) { %>
    <div class="row">

        <% wishlist.forEach(item => { %>
        <div class="col-md-4 mb-4">
            <div class="card h-100">

                <% if (item?.listing?.image?.url) { %>
                    <img src="<%= item.listing.image.url %>" class="card-img-top">
                <% } else { %>
                    <img src="/images/no-image.jpg" class="card-img-top">
                <% } %>

                <div class="card-body">
                    <h5><%= item?.listing?.title || "Listing Removed" %></h5>

                        <!-- ===== VIEW DETAILS SAFE ===== -->
                    <% if (item?.listing?._id) { %>
                        <a href="/listings/<%= item.listing._id %>" class="btn btn-primary btn-sm">
                        View Details
                        </a>
                    <% } else { %>
                        <a href="#" class="btn btn-primary btn-sm disabled">
                        View Details
                        </a>
                    <% } %>
                    
                </div>
            </div>
        </div>

    <% }) %>
    </div>
    <% } else { %>

    <div class="empty-trips">
        <h3>Wishlist Empty</h3>
    </div>

    <% } %>
</div>

</div>

<script>
    document.querySelectorAll(".trip-tab").forEach(tab=>{
        tab.addEventListener("click", () => {
            document.querySelectorAll(".trip-tab").forEach(t => t.classList.remove("active"))
            tab.classList.add("active")

            document.querySelectorAll(".trip-section").forEach(s => s.classList.add("d-none"))
            document.getElementById(tab.dataset.tab+"-trips")?.classList.remove("d-none")
            document.getElementById(tab.dataset.tab+"-section")?.classList.remove("d-none")
        });
    });
</script>
